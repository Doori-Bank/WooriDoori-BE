version: '3.8'

services:
  # Nginx 로드밸런서
  nginx-lb:
    image: nginx:alpine
    container_name: nginx-loadbalancer
    ports:
      - "8080:8080"  # 외부에서 접근할 포트
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - wooridoori-instance1
      - wooridoori-instance2
    restart: unless-stopped
    networks:
      - wooridoori-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # 우리두리 인스턴스 1
  wooridoori-instance1:
    build:
      context: ./WooriDoori-App-BE/Woori-Doori-BE
      dockerfile: Dockerfile
    container_name: wooridoori-instance1
    # 외부 포트는 노출하지 않음 (Nginx를 통해서만 접근)
    expose:
      - "8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB1_URL=${DB1_URL}
      - DB1_USERNAME=${DB1_USERNAME}
      - DB1_PASSWORD=${DB1_PASSWORD}
      - DB2_URL=${DB2_URL}
      - DB2_USERNAME=${DB2_USERNAME}
      - DB2_PASSWORD=${DB2_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - JWT_SECRET=${JWT_SECRET}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - SERVER_PORT=8080
    restart: unless-stopped
    networks:
      - wooridoori-network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # 외부 Redis 접근용
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # 우리두리 인스턴스 2
  wooridoori-instance2:
    build:
      context: ./WooriDoori-App-BE/Woori-Doori-BE
      dockerfile: Dockerfile
    container_name: wooridoori-instance2
    # 외부 포트는 노출하지 않음 (Nginx를 통해서만 접근)
    expose:
      - "8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB1_URL=${DB1_URL}
      - DB1_USERNAME=${DB1_USERNAME}
      - DB1_PASSWORD=${DB1_PASSWORD}
      - DB2_URL=${DB2_URL}
      - DB2_USERNAME=${DB2_USERNAME}
      - DB2_PASSWORD=${DB2_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - JWT_SECRET=${JWT_SECRET}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - SERVER_PORT=8080
    restart: unless-stopped
    networks:
      - wooridoori-network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # 외부 Redis 접근용
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Prometheus (메트릭 수집 및 저장)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    networks:
      - wooridoori-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # k6 (부하 테스트 도구) - 필요시 실행
  k6:
    image: grafana/k6:latest
    container_name: k6-runner
    volumes:
      - ./WooriDoori-App-BE/load_test:/scripts:ro
    networks:
      - wooridoori-network
    profiles:
      - loadtest  # 기본적으로는 실행되지 않음 (--profile loadtest로 실행)
    # 실제 테스트는 docker exec로 실행:
    # docker exec -it k6-runner k6 run --out prometheus=remote=http://prometheus:9090 /scripts/full_workflow_stress_test.js
    command: sleep infinity  # 컨테이너를 유지하기 위해

volumes:
  nginx-logs:
  prometheus-data:

networks:
  wooridoori-network:
    driver: bridge

